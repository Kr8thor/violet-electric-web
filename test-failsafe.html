<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Failsafe System Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .status-box {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeeba; }
        button {
            margin: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Triple Failsafe System Diagnostic</h1>
    
    <div id="status"></div>
    
    <h2>Storage Layers Status:</h2>
    <div id="storage-status"></div>
    
    <h2>Test Controls:</h2>
    <button onclick="testSave()">Test Save to All Layers</button>
    <button onclick="testRecovery()">Test Failover Recovery</button>
    <button onclick="simulateWordPressSave()">Simulate WordPress Save</button>
    <button onclick="clearAll()">Clear All Storage</button>
    <button onclick="checkAllLayers()">Check All Layers</button>
    
    <h2>Current Content:</h2>
    <pre id="content-display"></pre>
    
    <h2>Test Results:</h2>
    <div id="results"></div>

    <script>
        // Check if we're in the iframe context
        const isInIframe = window.parent !== window;
        const statusEl = document.getElementById('status');
        const storageStatusEl = document.getElementById('storage-status');
        const contentDisplayEl = document.getElementById('content-display');
        const resultsEl = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status-box ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            resultsEl.appendChild(div);
            console.log(message);
        }
        
        function checkStorageLayers() {
            let status = '<h3>Storage Layer Check:</h3>';
            
            // Check LocalStorage
            try {
                const primary = localStorage.getItem('violet-content-primary');
                const backup = localStorage.getItem('violet-content-backup');
                status += `<div class="status-box ${primary ? 'success' : 'warning'}">
                    LocalStorage Primary: ${primary ? 'Active (' + primary.length + ' bytes)' : 'Empty'}
                </div>`;
                status += `<div class="status-box ${backup ? 'success' : 'warning'}">
                    LocalStorage Backup: ${backup ? 'Active (' + backup.length + ' bytes)' : 'Empty'}
                </div>`;
            } catch (e) {
                status += '<div class="status-box error">LocalStorage: Error - ' + e.message + '</div>';
            }
            
            // Check SessionStorage
            try {
                const session = sessionStorage.getItem('violet-content-session');
                status += `<div class="status-box ${session ? 'success' : 'warning'}">
                    SessionStorage: ${session ? 'Active (' + session.length + ' bytes)' : 'Empty'}
                </div>`;
            } catch (e) {
                status += '<div class="status-box error">SessionStorage: Error - ' + e.message + '</div>';
            }
            
            // Check IndexedDB
            status += '<div class="status-box warning">IndexedDB: Check console for status</div>';
            
            storageStatusEl.innerHTML = status;
        }
        
        function displayContent() {
            try {
                const content = {};
                
                // Try to get from primary storage
                const primary = localStorage.getItem('violet-content-primary');
                if (primary) {
                    const parsed = JSON.parse(primary);
                    Object.assign(content, parsed.data || parsed);
                }
                
                // Display
                contentDisplayEl.textContent = JSON.stringify(content, null, 2);
            } catch (e) {
                contentDisplayEl.textContent = 'Error reading content: ' + e.message;
            }
        }
        
        function testSave() {
            log('Testing save to all layers...', 'warning');
            
            const testData = {
                test_field: 'Test value ' + Date.now(),
                hero_title: 'Failsafe Test Hero Title',
                timestamp: Date.now()
            };
            
            // Save to all layers
            try {
                // Primary
                localStorage.setItem('violet-content-primary', JSON.stringify({
                    data: testData,
                    timestamp: Date.now(),
                    version: Date.now()
                }));
                log('‚úÖ Saved to LocalStorage Primary', 'success');
                
                // Backup
                localStorage.setItem('violet-content-backup', JSON.stringify(testData));
                log('‚úÖ Saved to LocalStorage Backup', 'success');
                
                // Session
                sessionStorage.setItem('violet-content-session', JSON.stringify({
                    data: testData,
                    timestamp: Date.now()
                }));
                log('‚úÖ Saved to SessionStorage', 'success');
                
                // Window object
                window.__violetContentFailsafe = testData;
                log('‚úÖ Saved to Window object', 'success');
                
            } catch (e) {
                log('‚ùå Save error: ' + e.message, 'error');
            }
            
            checkStorageLayers();
            displayContent();
        }
        
        function testRecovery() {
            log('Testing failover recovery...', 'warning');
            
            // Corrupt primary
            localStorage.setItem('violet-content-primary', 'CORRUPTED_DATA');
            log('‚ùå Corrupted primary storage', 'error');
            
            // Try to recover
            let recovered = false;
            let content = null;
            
            // Try backup
            try {
                const backup = localStorage.getItem('violet-content-backup');
                if (backup) {
                    content = JSON.parse(backup);
                    recovered = true;
                    log('‚úÖ Recovered from backup storage', 'success');
                }
            } catch (e) {}
            
            // Try session
            if (!recovered) {
                try {
                    const session = sessionStorage.getItem('violet-content-session');
                    if (session) {
                        const parsed = JSON.parse(session);
                        content = parsed.data || parsed;
                        recovered = true;
                        log('‚úÖ Recovered from session storage', 'success');
                    }
                } catch (e) {}
            }
            
            // Try window
            if (!recovered && window.__violetContentFailsafe) {
                content = window.__violetContentFailsafe;
                recovered = true;
                log('‚úÖ Recovered from window object', 'success');
            }
            
            if (recovered) {
                log('‚úÖ Recovery successful! Content: ' + JSON.stringify(content), 'success');
            } else {
                log('‚ùå Recovery failed - no backup found', 'error');
            }
            
            checkStorageLayers();
        }
        
        function simulateWordPressSave() {
            log('Simulating WordPress save...', 'warning');
            
            const testChanges = [
                {
                    field_name: 'hero_title',
                    field_value: 'WordPress Save Test ' + Date.now()
                },
                {
                    field_name: 'hero_subtitle',
                    field_value: 'This is a test subtitle'
                }
            ];
            
            // Send to parent if in iframe
            if (isInIframe) {
                window.parent.postMessage({
                    type: 'violet-apply-saved-changes',
                    savedChanges: testChanges,
                    timestamp: Date.now()
                }, '*');
                log('üì§ Sent to parent frame', 'success');
            }
            
            // Also handle locally
            window.postMessage({
                type: 'violet-apply-saved-changes',
                savedChanges: testChanges,
                timestamp: Date.now()
            }, '*');
            
            log('üì§ Sent locally', 'success');
            
            setTimeout(() => {
                checkStorageLayers();
                displayContent();
            }, 1000);
        }
        
        function clearAll() {
            if (!confirm('Clear all storage?')) return;
            
            try {
                localStorage.removeItem('violet-content-primary');
                localStorage.removeItem('violet-content-backup');
                sessionStorage.removeItem('violet-content-session');
                delete window.__violetContentFailsafe;
                
                log('üóëÔ∏è All storage cleared', 'success');
                checkStorageLayers();
                displayContent();
            } catch (e) {
                log('‚ùå Clear error: ' + e.message, 'error');
            }
        }
        
        function checkAllLayers() {
            checkStorageLayers();
            displayContent();
        }
        
        // Initial status
        statusEl.innerHTML = `
            <div class="status-box ${isInIframe ? 'success' : 'warning'}">
                Context: ${isInIframe ? 'Inside iframe (WordPress Editor)' : 'Standalone page'}
            </div>
            <div class="status-box success">
                URL: ${window.location.href}
            </div>
        `;
        
        // Initial check
        checkStorageLayers();
        displayContent();
        
        // Listen for messages
        window.addEventListener('message', (event) => {
            log(`üì® Received message: ${event.data.type || 'unknown'}`, 'warning');
            if (event.data.type === 'violet-apply-saved-changes') {
                log('WordPress save detected!', 'success');
                setTimeout(() => {
                    checkStorageLayers();
                    displayContent();
                }, 500);
            }
        });
        
        log('üõ°Ô∏è Failsafe diagnostic tool ready', 'success');
    </script>
</body>
</html>
