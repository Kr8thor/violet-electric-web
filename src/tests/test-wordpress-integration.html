<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress Integration Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .success {
            color: #00a32a;
            background: #e5f5e5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #d63939;
            background: #ffe5e5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #0073aa;
            background: #e5f3ff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .content-display {
            background: white;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-connected { background: #00a32a; }
        .status-disconnected { background: #d63939; }
        .status-syncing { background: #f56500; animation: pulse 1s infinite; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <h1>WordPress Integration Test Suite</h1>
    
    <div class="test-section">
        <h2>1. API Connection Test</h2>
        <div id="api-test-results"></div>
        <button onclick="testAPI()">Test WordPress API</button>
        <button onclick="testProxyAPI()">Test Netlify Proxy</button>
    </div>
    
    <div class="test-section">
        <h2>2. Current Content</h2>
        <div id="current-content" class="content-display">Loading...</div>
        <button onclick="loadContent()">Refresh Content</button>
        <button onclick="clearLocalStorage()">Clear Cache</button>
    </div>
    
    <div class="test-section">
        <h2>3. Message Communication Test</h2>
        <div id="message-test-results"></div>
        <button onclick="simulateSave()">Simulate WordPress Save</button>
        <button onclick="testGracePeriod()">Test Grace Period</button>
    </div>
    
    <div class="test-section">
        <h2>4. Content Sync Status</h2>
        <div id="sync-status">
            <p><span class="status-indicator status-disconnected"></span>Status: <span id="sync-status-text">Not connected</span></p>
            <p>Last Sync: <span id="last-sync">Never</span></p>
            <p>Grace Period Active: <span id="grace-period">No</span></p>
            <p>Cache Status: <span id="cache-status">Unknown</span></p>
        </div>
    </div>
    
    <div class="test-section">
        <h2>5. Debug Log</h2>
        <div id="debug-log" class="content-display" style="font-family: monospace; font-size: 12px;"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script>
        // Logging utility
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('debug-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[Test] ${message}`);
        };

        // Test WordPress API directly
        async function testAPI() {
            log('Testing direct WordPress API connection...');
            const resultsDiv = document.getElementById('api-test-results');
            
            try {
                const response = await fetch('https://wp.violetrainwater.com/wp-json/violet/v1/content', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    credentials: 'omit'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.innerHTML = '<div class="success">✅ Direct API connection successful!</div>';
                    log(`Received ${Object.keys(data).length} content fields`, 'success');
                    displayContent(data);
                } else {
                    resultsDiv.innerHTML = `<div class="error">❌ API returned status: ${response.status}</div>`;
                    log(`API error: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Connection failed: ${error.message}</div>`;
                log(`Connection error: ${error.message}`, 'error');
            }
        }

        // Test Netlify proxy
        async function testProxyAPI() {
            log('Testing Netlify proxy API connection...');
            const resultsDiv = document.getElementById('api-test-results');
            
            try {
                const response = await fetch('/wp-json/violet/v1/content', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultsDiv.innerHTML = '<div class="success">✅ Proxy API connection successful!</div>';
                    log(`Proxy received ${Object.keys(data).length} content fields`, 'success');
                    displayContent(data);
                } else {
                    resultsDiv.innerHTML = `<div class="error">❌ Proxy returned status: ${response.status}</div>`;
                    log(`Proxy error: ${response.status}`, 'error');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Proxy failed: ${error.message}</div>`;
                log(`Proxy error: ${error.message}`, 'error');
            }
        }

        // Display content
        function displayContent(content) {
            const contentDiv = document.getElementById('current-content');
            contentDiv.innerHTML = '<h3>Current Content:</h3>' + 
                '<pre>' + JSON.stringify(content, null, 2) + '</pre>';
        }

        // Load content from localStorage
        function loadContent() {
            log('Loading content from localStorage...');
            const stored = localStorage.getItem('violet-content');
            const state = localStorage.getItem('violet-content-state');
            
            if (stored) {
                try {
                    const content = JSON.parse(stored);
                    displayContent(content);
                    log(`Loaded ${Object.keys(content).length} fields from cache`, 'success');
                    
                    // Update cache status
                    document.getElementById('cache-status').textContent = `${Object.keys(content).length} fields cached`;
                } catch (e) {
                    log('Failed to parse cached content', 'error');
                }
            } else {
                document.getElementById('current-content').innerHTML = '<div class="info">No cached content found</div>';
                log('No cached content found', 'info');
            }
            
            // Check content state
            if (state) {
                try {
                    const stateData = JSON.parse(state);
                    log(`Content state: ${Object.keys(stateData).join(', ')}`, 'info');
                } catch (e) {
                    log('Failed to parse content state', 'error');
                }
            }
        }

        // Clear localStorage
        function clearLocalStorage() {
            log('Clearing localStorage...');
            localStorage.removeItem('violet-content');
            localStorage.removeItem('violet-content-state');
            localStorage.removeItem('violet-content-cache');
            localStorage.removeItem('violet-content-cache_time');
            localStorage.removeItem('violet-content-cache_grace_end');
            localStorage.removeItem('violet-last-sync-timestamp');
            document.getElementById('current-content').innerHTML = '<div class="info">Cache cleared</div>';
            document.getElementById('cache-status').textContent = 'Empty';
            log('Cache cleared successfully', 'success');
        }

        // Simulate WordPress save
        function simulateSave() {
            log('Simulating WordPress save message...');
            const messageDiv = document.getElementById('message-test-results');
            
            const testChanges = [
                { field_name: 'hero_title', field_value: 'Test Hero Title - ' + new Date().toLocaleTimeString() },
                { field_name: 'hero_subtitle', field_value: 'Test subtitle updated at ' + new Date().toLocaleTimeString() }
            ];
            
            window.postMessage({
                type: 'violet-apply-saved-changes',
                savedChanges: testChanges,
                timestamp: Date.now(),
                syncDelay: 30000
            }, '*');
            
            messageDiv.innerHTML = '<div class="success">✅ Save message sent! Check if content updates.</div>';
            log('Save message sent with 30s grace period', 'success');
            
            // Update grace period indicator
            document.getElementById('grace-period').textContent = 'Yes (30 seconds)';
            setTimeout(() => {
                document.getElementById('grace-period').textContent = 'No';
                log('Grace period ended', 'info');
            }, 30000);
        }

        // Test grace period
        function testGracePeriod() {
            log('Testing grace period functionality...');
            const messageDiv = document.getElementById('message-test-results');
            
            // Check localStorage for grace period
            const graceEnd = localStorage.getItem('violet-content-cache_grace_end');
            
            if (graceEnd) {
                const remaining = parseInt(graceEnd) - Date.now();
                if (remaining > 0) {
                    messageDiv.innerHTML = `<div class="info">✅ Grace period active! ${Math.round(remaining/1000)}s remaining</div>`;
                    log(`Grace period active: ${Math.round(remaining/1000)}s remaining`, 'info');
                } else {
                    messageDiv.innerHTML = '<div class="info">Grace period has expired</div>';
                    log('Grace period expired', 'info');
                }
            } else {
                messageDiv.innerHTML = '<div class="info">No grace period currently active</div>';
                log('No grace period active', 'info');
            }
            
            // Check if violetDebug is available
            if (window.violetDebug) {
                const inGrace = window.violetDebug.isInGracePeriod();
                log(`violetDebug.isInGracePeriod(): ${inGrace}`, 'info');
            } else {
                log('violetDebug not available on window', 'error');
            }
        }

        // Clear log
        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }

        // Update sync status
        function updateSyncStatus() {
            const lastSyncTime = localStorage.getItem('violet-last-sync-timestamp');
            if (lastSyncTime) {
                const date = new Date(parseInt(lastSyncTime));
                document.getElementById('last-sync').textContent = date.toLocaleString();
            }
            
            // Check connection status
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('sync-status-text');
            
            // Simple connection check based on whether we have content
            const hasContent = localStorage.getItem('violet-content');
            if (hasContent) {
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = 'Connected';
            }
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            log('Test suite initialized', 'info');
            loadContent();
            updateSyncStatus();
            
            // Listen for content updates
            window.addEventListener('violet-content-updated', (event) => {
                log('Content update event received', 'success');
                loadContent();
            });
            
            window.addEventListener('violet-content-synced', (event) => {
                log('Content synced from WordPress', 'success');
                loadContent();
                updateSyncStatus();
            });
            
            // Update status every 5 seconds
            setInterval(() => {
                updateSyncStatus();
            }, 5000);
        });
    </script>
</body>
</html>
