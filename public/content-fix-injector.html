<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Persistence Fix Injector</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .code-block {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
        button {
            background: #0073aa;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #005a87;
        }
        .success {
            color: #00ff00;
        }
        .error {
            color: #ff0000;
        }
        .info {
            color: #00aaff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Content Persistence Fix Injector</h1>
        <p>Copy and paste this script into your browser console while on the React site to fix content persistence issues.</p>
        
        <div class="code-block" id="fix-script">
// üîß Content Persistence Fix - Inject this into your React app console
(function() {
    console.log('üöÄ Injecting content persistence fix...');
    
    // Override content sync to respect grace period
    const originalSync = window.syncWordPressContent;
    if (originalSync) {
        window.syncWordPressContent = async function() {
            const graceEnd = localStorage.getItem('violet-grace-period-end');
            if (graceEnd && parseInt(graceEnd) > Date.now()) {
                console.log('‚è∏Ô∏è Sync blocked - grace period active');
                return false;
            }
            return originalSync.apply(this, arguments);
        };
    }
    
    // Enhanced message handler
    const enhancedMessageHandler = (event) => {
        console.log('üì® Message received:', event.data.type);
        
        if (event.data.type === 'violet-apply-saved-changes' && event.data.savedChanges) {
            console.log('üíæ Processing WordPress save...');
            
            // Extract changes
            const updates = {};
            event.data.savedChanges.forEach(change => {
                if (change.field_name && change.field_value !== undefined) {
                    updates[change.field_name] = change.field_value;
                }
            });
            
            // Get current content
            const currentContent = JSON.parse(localStorage.getItem('violet-content') || '{}');
            const mergedContent = { ...currentContent, ...updates };
            
            // Save with protection
            localStorage.setItem('violet-content', JSON.stringify(mergedContent));
            localStorage.setItem('violet-protected-content', JSON.stringify(mergedContent));
            const syncDelay = typeof event.data.syncDelay === 'number' ? event.data.syncDelay : 30000;
            localStorage.setItem('violet-grace-period-end', (Date.now() + syncDelay).toString());
            
            console.log('‚úÖ Content saved and protected for 30 seconds');
            
            // Force React to update
            window.dispatchEvent(new CustomEvent('violet-content-updated', { detail: updates }));
            
            // Also update any visible content immediately
            Object.entries(updates).forEach(([field, value]) => {
                const elements = document.querySelectorAll(`[data-violet-field="${field}"]`);
                elements.forEach(el => {
                    if (el.textContent !== value) {
                        el.textContent = value;
                        el.style.backgroundColor = 'rgba(255, 255, 0, 0.2)';
                        setTimeout(() => {
                            el.style.backgroundColor = '';
                        }, 2000);
                    }
                });
            });
        }
    };
    
    // Remove existing listener and add enhanced one
    window.removeEventListener('message', window._violetMessageHandler);
    window._violetMessageHandler = enhancedMessageHandler;
    window.addEventListener('message', enhancedMessageHandler);
    
    // Monitor and prevent content reversion
    let lastContent = localStorage.getItem('violet-content');
    setInterval(() => {
        const graceEnd = localStorage.getItem('violet-grace-period-end');
        if (graceEnd && parseInt(graceEnd) > Date.now()) {
            // We're in grace period
            const protectedContent = localStorage.getItem('violet-protected-content');
            const currentContent = localStorage.getItem('violet-content');
            
            if (protectedContent && currentContent !== protectedContent) {
                console.log('üõ°Ô∏è Preventing content reversion during grace period');
                localStorage.setItem('violet-content', protectedContent);
                window.dispatchEvent(new CustomEvent('violet-content-updated', { 
                    detail: JSON.parse(protectedContent) 
                }));
            }
        }
    }, 500);
    
    console.log('‚úÖ Content persistence fix injected successfully!');
    console.log('‚ÑπÔ∏è Try editing and saving now - content should persist.');
})();
        </div>
        
        <button onclick="copyScript()">üìã Copy Script</button>
        <button onclick="testGracePeriod()">üß™ Test Grace Period</button>
        <button onclick="clearGracePeriod()">üóëÔ∏è Clear Grace Period</button>
        <button onclick="checkStatus()">üìä Check Status</button>
        
        <div id="status" style="margin-top: 20px;"></div>
    </div>
    
    <script>
        function copyScript() {
            const script = document.getElementById('fix-script').textContent;
            navigator.clipboard.writeText(script).then(() => {
                showStatus('Script copied to clipboard!', 'success');
            }).catch(err => {
                showStatus('Failed to copy: ' + err, 'error');
            });
        }
        
        function testGracePeriod() {
            const testScript = `
// Test grace period
localStorage.setItem('violet-grace-period-end', (Date.now() + 30000).toString());
console.log('‚úÖ Grace period set for 30 seconds');
            `;
            navigator.clipboard.writeText(testScript);
            showStatus('Test script copied - paste in console to activate grace period', 'info');
        }
        
        function clearGracePeriod() {
            const clearScript = `
// Clear grace period
localStorage.removeItem('violet-grace-period-end');
localStorage.removeItem('violet-protected-content');
console.log('‚úÖ Grace period cleared');
            `;
            navigator.clipboard.writeText(clearScript);
            showStatus('Clear script copied - paste in console to clear grace period', 'info');
        }
        
        function checkStatus() {
            const checkScript = `
// Check content status
console.log('üìä Content Status:');
console.log('Content:', localStorage.getItem('violet-content'));
console.log('Protected:', localStorage.getItem('violet-protected-content'));
const graceEnd = localStorage.getItem('violet-grace-period-end');
if (graceEnd) {
    const remaining = Math.round((parseInt(graceEnd) - Date.now()) / 1000);
    console.log('Grace period:', remaining > 0 ? remaining + 's remaining' : 'Expired');
} else {
    console.log('Grace period: Not active');
}
            `;
            navigator.clipboard.writeText(checkScript);
            showStatus('Status check script copied - paste in console', 'info');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<p class="${type}">${message}</p>`;
        }
    </script>
</body>
</html>
